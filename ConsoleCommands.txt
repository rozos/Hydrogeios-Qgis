# Install QGIS 2.4
# Install TauDEM 5.1.2 Command Line Executables
# Install hydrogeios-qgis


# Define paths
pluginpath="c:/dev/hydrogeios-qgis"
projectpath="c:/dev/testHydrogeios/Sarantapotamos"
taudempath="c:/dev/TauDem"

# Define raster files. These files should be of geotiff format and have consistend # projection
demname="Sarantapotamos"
cnname="CN"

# Define delineation threshold
threshold=150

# Define CN grouping
cngroups=(250, 600, 1500,)


# Import hydrogeios
import sys
sys.path.append(pluginpath)
import geoprocess
import TauDEM
import h_const
import h_utils
import h_hru
import h_initLayers
import h_groundWater
import h_topology


# Initialize TauDEM
TauDEM.initialize(taudempath, projectpath, demname)


# Initial delineation
TauDEM.autoDelineate(threshold)


# Define project projection (should be the same with DEM projection). Set Enable 
#'on the fly' CRS transformation. Load created River shapefile and use it (enable
# snapping before) to create the point layer MyOutlet.


# Delineate with user outputs
h_utils.unloadShapefile(h_const.riverLayerName)
TauDEM.autoDelineate(threshold, outlet="MyOutlet")


# Convert raster layer of subbasin to an intermediate shapefile
h_utils.createVectorFromRaster(projectpath, demname+'w.tif', 1, "Subbas", "DN")


# Load intermediate layer to delete nodata polygons
h_utils.loadShapefileToCanvas(projectpath, "Subbas")
dnvals=h_utils.getFieldAttrValues("Subbas", "DN")
nodataShapeId=h_utils.getElementIndexByVal(dnvals, h_const.nodataCode)
h_utils.delSpecificShapes("Subbas", nodataShapeId)



# Disolve Subbas layer to joing small polygons with mother polys
geoprocess.dissolve(projectpath, "Subbas", h_const.subbasLayerName )
h_utils.unloadShapefile("Subbas")
h_utils.unloadShapefile("MyOutlet")


# Delete from the attribute table of layer River the field Length
h_utils.loadShapefileToCanvas(projectpath, h_const.riverLayerName)
h_utils.delField(h_const.riverLayerName, "Length")


# Initialize template layers
h_initLayers.doAll(projectpath)


# Create HRU
h_utils.loadRasterfileToCanvas(projectpath, cnname)
h_hru.doAll(projectpath, cnname, bandnum=1, cngroups)


# Digitizie shapes in GroundWater layer
# Digitize boreholes
# Digitize springs


# Process groundwater cells
h_utils.loadShapefileToCanvas(projectpath, h_const.riverexitnodeLayerName)
h_groundWater.doAll(projectpath)


# Create hydrojunctions
h_const.DEMlayerName=demname
h_topology.createHydrojunctionLayer(projectpath)


# Add aqueduct nodes in hydrojunction
# Digitize Aqueduct


# Build topology
h_utils.addMeasureToAttrTable(h_const.aquedLayerName, h_const.aquedFieldLength)
h_topology.build()
